#include <string.h>
#include <math.h>

#include "gcode.h"
#include "fifo_char.h"


/* --------------------------------------- Импортированные переменные из библиотеки interpolator.h --------------------------------------- */

/* ------------ Глобальные координаты станка (шаги) ------------- */

/* Координаты линейных осей станка */
extern volatile int64_t x;
extern volatile int64_t y;
extern volatile int64_t z;

/* Координаты поворотных осей станка */
extern volatile int64_t a;
extern volatile int64_t b;
extern volatile int64_t c;

/* ------------ Глобальные координаты станка (мм) ------------- */

/* Координаты линейных осей станка */
extern volatile double X;
extern volatile double Y;
extern volatile double Z;

/* Координаты поворотных осей станка */
extern volatile double A;
extern volatile double B;
extern volatile double C;

/* --------------------------------------- Импортированные переменные из библиотеки interpolator.h --------------------------------------- */

/* Глобальные переменные для предварительных расчетов в шагах */
double Xk;
double Yk;
double I;
double J;

/* Структура отрезка */
LINE_StructDef line;

/* Структура дуги */
ARC_StructDef arc;

/* Дефолтный буфер g - кода */
char* GcodeBuffer[FIFO_GCODE_BUF_SIZE];

/* 5 строк, траектория - "пример" */
char* GcodeBufferExample[5] =
{
	"0",
	"G00 X0.000000 Y0.000000",
	"G01 X75.0 Y25.0",
	"G03 X-75.0 Y25.0 I-75.0 J25.0",
	"G01 X0.0 Y0.0"
};

/* 4 строки, траектория - "окружность" */
char* GcodeBufferCircle[4] =
{
	"0",
	"G00 X0.000000 Y0.000000",
	"G02 X0.0 Y40.0 I0.0 J20.0",
	"G02 X0.0 Y0.0 I0.0 J-20.0"
};

/* 19 строк, траектория - "тестовая деталь" */
char* GcodeBuffer1[19] =
{
	"0",
	"G00 X0.000000 Y0.000000",
	"G01 X-45.000000 Y0.000000",
	"G02 X-50.000000 Y5.000000 I0.000000 J5.000000",
	"G01 X-50.000000 Y45.000000",
	"G02 X-45.000000 Y50.000000 I5.000000 J0.000000",
	"G01 X-25.000000 Y50.000000",
	"G02 X-20.000000 Y45.000000 I0.000000 J-5.000000",
	"G01 X-20.000000 Y30.000000",
	"G03 X-15.000000 Y25.000000 I5.000000 J0.000000",
	"G01 X15.000000 Y25.000000",
	"G03 X20.000000 Y30.000000 I0.000000 J5.000000",
	"G01 X20.000000 Y45.000000",
	"G02 X25.000000 Y50.000000 I5.000000 J0.000000",
	"G01 X45.000000 Y50.000000",
	"G02 X50.000000 Y45.000000 I0.000000 J-5.000000",
	"G01 X50.000000 Y5.000000",
	"G02 X45.000000 Y0.000000 I-5.000000 J0.000000",
	"G01 X0.000000 Y0.000000"
};

/* 119 строк, траектория - "жираф" */
char* GcodeBuffer2[119] =
{
	"G00 X0.000000 Y0.000000",
	"G00 X56.720960 Y5.154450",
	"G02 X55.026071 Y6.667147 I0.200114 J1.930077",
	"G02 X52.958512 Y22.236840 I90.580843 J19.950702",
	"G01 X52.684559 Y28.030330",
	"G01 X45.478459 Y28.030330",
	"G01 X38.272358 Y28.030330",
	"G01 X38.048008 Y17.561400",
	"G02 X37.771711 Y8.491358 I-502.545045 J10.769602",
	"G02 X37.355923 Y6.462535 I-6.389117 J0.252370",
	"G02 X36.147447 Y5.552828 I-1.328580 J0.507380",
	"G02 X33.477170 Y5.592620 I-1.135745 J13.400526",
	"G01 X31.037807 Y5.872790",
	"G01 X30.777013 Y8.312150",
	"G02 X30.612940 Y10.756918 I30.851789 J3.298415",
	"G02 X30.472092 Y19.390920 I385.213018 J10.602184",
	"G01 X30.427962 Y28.030330",
	"G01 X27.382362 Y28.030330",
	"G01 X24.336761 Y28.030330",
	"G01 X24.421221 Y17.358120",
	"G02 X23.209367 Y6.965177 I-42.300088 J-0.334783",
	"G02 X21.561274 Y5.675060 I-1.644029 J0.402449",
	"G02 X18.744847 Y5.884691 I0.047034 J19.656325",
	"G02 X17.528682 Y6.784844 I0.233745 J1.587441",
	"G02 X17.022896 Y8.633975 I4.956440 J2.349456",
	"G02 X16.360499 Y16.646640 I451.775193 J41.381388",
	"G02 X17.582527 Y37.656910 I79.904055 J5.893183",
	"G02 X22.824265 Y50.289511 I33.229423 J-6.384331",
	"G03 X23.926006 Y52.110049 I-16.737751 J11.372877",
	"G03 X23.826211 Y52.289610 I-0.107688 J0.057662",
	"G03 X23.445552 Y52.192361 I-0.040998 J-0.633148",
	"G03 X20.791998 Y50.421105 I36.084996 J-56.932962",
	"G03 X16.146238 Y46.176336 I14.157782 J-20.159928",
	"G03 X12.466773 Y40.890129 I26.098246 J-22.089335",
	"G03 X10.163925 Y35.092602 I20.087738 J-11.335218",
	"G03 X10.655166 Y32.457090 I3.143855 J-0.777545",
	"G02 X11.136468 Y30.862309 I-2.182526 J-1.528701",
	"G02 X10.731161 Y27.971765 I-12.768973 J0.316755",
	"G02 X9.664300 Y25.357564 I-10.254940 J2.660267",
	"G02 X8.663069 Y24.777850 I-1.001231 J0.574762",
	"G02 X6.526938 Y26.856618 I0.000000 J2.136923",
	"G02 X8.460250 Y32.227770 I7.835146 J0.213307",
	"G03 X9.365279 Y33.630678 I-4.341065 J3.793837",
	"G03 X10.062638 Y35.743670 I-9.318862 J4.247110",
	"G02 X14.399844 Y45.078225 I22.557552 J-4.806241",
	"G02 X22.909474 Y52.296763 I21.415038 J-16.620193",
	"G03 X24.852363 Y53.650757 I-5.023416 J9.279216",
	"G03 X27.538896 Y56.366044 I-18.123821 J20.618577",
	"G02 X34.848006 Y63.588518 I48.188343 J-41.456748",
	"G02 X45.953755 Y71.830248 I74.049977 J-88.179130",
	"G03 X50.380470 Y75.126020 I-24.487715 J37.511425",
	"G03 X52.541860 Y77.397621 I-9.333541 J11.044768",
	"G03 X57.248162 Y86.151499 I-25.009524 J19.087790",
	"G03 X63.156066 Y107.919449 I-153.046063 J53.222972",
	"G03 X67.695027 Y133.379258 I-669.851949 J132.555344",
	"G03 X67.351231 Y134.336806 I-1.043741 J0.165750",
	"G03 X67.210041 Y134.434142 I-0.473194 J-0.535320",
	"G03 X65.165178 Y135.483996 I-59.637347 J-113.642808",
	"G02 X61.094715 Y139.364362 I4.323900 J8.610844",
	"G02 X61.584654 Y141.837734 I1.687479 J0.950946",
	"G02 X64.172852 Y142.188782 I1.592502 J-2.024539",
	"G02 X68.024445 Y139.138581 I-3.523100 J-8.405607",
	"G03 X69.498414 Y137.751657 I4.387433 J3.186094",
	"G03 X70.202633 Y137.750860 I0.352737 J0.553661",
	"G03 X70.762942 Y139.114610 I-0.683146 J1.077655",
	"G03 X69.144505 Y142.349824 I-7.485577 J-1.722284",
	"G02 X69.030633 Y143.344834 I0.689949 J0.582981",
	"G02 X69.939128 Y143.900044 I0.908495 J-0.465683",
	"G02 X70.410590 Y143.597960 I0.000000 J-0.518947",
	"G02 X70.524536 Y142.627354 I-1.436134 J-0.660589",
	"G03 X70.863575 Y139.210713 I5.765246 J-1.153047",
	"G03 X72.368030 Y138.208199 I1.504455 J0.627598",
	"G01 X73.523357 Y138.208199",
	"G01 X73.523357 Y139.956409",
	"G03 X73.350426 Y141.632988 I-8.213744 J-0.000000",
	"G03 X73.062813 Y142.165163 I-1.035753 J-0.215963",
	"G02 X72.825258 Y143.279832 I0.740450 J0.740451",
	"G02 X73.726637 Y143.900044 I0.901379 J-0.344898",
	"G02 X74.628017 Y143.279831 I-0.000000 J-0.965112",
	"G02 X74.390462 Y142.165163 I-0.978006 J-0.374218",
	"G03 X74.102849 Y141.632988 I0.748140 J-0.748138",
	"G03 X73.929918 Y139.956409 I8.040813 J-1.676579",
	"G01 X73.929918 Y138.208199",
	"G01 X74.907509 Y138.208199",
	"G03 X75.694585 Y138.534479 I-0.000000 J1.112460",
	"G03 X77.154892 Y140.458146 I-6.324134 J6.316930",
	"G02 X79.597624 Y143.027791 I6.332408 J-3.573789",
	"G02 X81.569305 Y143.253105 I1.218670 J-1.924792",
	"G02 X82.398962 Y141.865824 I-0.417192 J-1.191226",
	"G02 X80.907791 Y139.046073 I-4.855249 J0.763441",
	"G01 X78.872092 Y137.134859",
	"G01 X82.674929 Y133.238218",
	"G02 X92.338525 Y120.213285 I-43.151638 J-42.112847",
	"G02 X91.777899 Y116.709861 I-2.527633 J-1.392091",
	"G02 X90.215366 Y116.237779 I-1.261763 J1.354344",
	"G02 X83.495374 Y118.073801 I5.478276 J33.266820",
	"G03 X77.909379 Y119.996386 I-27.604119 J-71.126422",
	"G03 X77.558278 Y119.863335 I-0.088940 J-0.295076",
	"G03 X76.974309 Y118.121165 I3.425846 J-2.117288",
	"G03 X73.341190 Y74.784776 I2246.185488 J-210.130123",
	"G02 X72.325364 Y61.165462 I-15197.312948 J1126.677467",
	"G02 X71.831074 Y54.660036 I-3467.718063 J260.209779",
	"G03 X71.527618 Y48.147686 I107.599231 J-8.277045",
	"G03 X71.370625 Y26.505730 I1189.130414 J-19.447631",
	"G01 X71.410565 Y4.856390",
	"G01 X68.831910 Y4.856390",
	"G02 X66.339422 Y5.010940 I0.000000 J20.175954",
	"G02 X66.038311 Y5.204170 I0.051159 J0.410948",
	"G02 X65.481219 Y6.750712 I3.388551 J2.094226",
	"G02 X63.928008 Y20.407320 I275.850464 J38.290003",
	"G03 X62.344518 Y27.557053 I-28.266092 J-2.510025",
	"G03 X61.105898 Y28.202680 I-0.970763 J-0.351440",
	"G01 X60.275414 Y27.979570",
	"G01 X60.445180 Y16.778270",
	"G02 X59.801484 Y5.654228 I-76.424917 J-1.158294",
	"G02 X58.887179 Y4.930960 I-0.829521 J0.109088",
	"G02 X58.277377 Y4.993495 I53.626561 J525.935712",
	"G02 X56.720946 Y5.154450 I292.980326 J2840.718692",
	"G01 X56.720960 Y5.154450"
};

/* 129 строк, траектория - "медуза" */
char* GcodeBuffer3[129] =
{
	"0",
	"G00 X0.000000 Y0.000000",
	"G00 X76.710707 Y5.929650",
	"G02 X77.917788 Y17.272217 I9.457972 J4.728991",
	"G03 X80.734117 Y28.690646 I-10.914423 J8.748553",
	"G03 X77.385566 Y35.836873 I-15.896177 J-3.090930",
	"G02 X74.066752 Y43.174916 I12.155292 J9.917065",
	"G02 X73.734565 Y49.105088 I26.881163 J4.480176",
	"G02 X74.871437 Y54.900277 I21.058522 J-1.122051",
	"G02 X76.138287 Y57.290278 I8.372012 J-2.906937",
	"G03 X77.170524 Y59.728367 I-4.462719 J3.326982",
	"G03 X75.625510 Y61.701685 I-1.684626 J0.272513",
	"G02 X73.262072 Y62.027459 I1.772920 J21.598321",
	"G02 X67.390121 Y63.277187 I32.458678 J166.929634",
	"G03 X62.341391 Y60.418094 I-0.966979 J-4.179658",
	"G03 X62.108229 Y57.356482 I6.224139 J-2.013694",
	"G02 X61.996527 Y54.210550 I-7.962694 J-1.292220",
	"G02 X59.786814 Y46.921926 I-59.337460 J14.010232",
	"G03 X59.697440 Y39.036553 I10.908034 J-4.066827",
	"G03 X61.999923 Y35.419985 I8.780240 J3.048708",
	"G02 X64.755436 Y32.139282 I-14.799277 J-15.227689",
	"G02 X68.375568 Y22.803519 I-18.340316 J-12.481602",
	"G02 X67.169481 Y12.826920 I-19.160931 J-2.744807",
	"G02 X65.606179 Y9.518691 I-29.001847 J11.681326",
	"G02 X62.916165 Y7.309110 I-4.085974 J2.232149",
	"G02 X63.538310 Y11.090754 I5.178062 J1.090119",
	"G03 X65.215257 Y14.896100 I-15.138363 J8.943375",
	"G03 X66.077110 Y21.185965 I-19.010977 J5.808912",
	"G03 X64.410572 Y27.311192 I-13.270038 J-0.321156",
	"G03 X58.704913 Y34.479040 I-24.349166 J-13.527315",
	"G02 X55.329167 Y43.174916 I6.931080 J7.693822",
	"G02 X57.073590 Y49.151507 I16.659679 J-1.619687",
	"G03 X59.352577 Y54.900277 I-29.469705 J15.008798",
	"G02 X60.203049 Y57.511345 I42.406276 J-12.368448",
	"G03 X59.812393 Y60.303141 I-2.844199 J1.025241",
	"G03 X56.835912 Y61.144188 I-2.017522 J-1.452615",
	"G02 X53.949713 Y60.418094 I-3.852668 J9.214908",
	"G02 X51.917625 Y60.512514 I-0.688968 J7.086499",
	"G03 X49.926303 Y60.073230 I-0.485995 J-2.530015",
	"G03 X48.983232 Y58.301531 I1.327172 J-1.843296",
	"G02 X48.661807 Y56.279731 I-8.132704 J0.256485",
	"G02 X46.598845 Y51.735160 I-16.888390 J4.925796",
	"G03 X44.523441 Y47.313278 I15.922622 J-10.171246",
	"G03 X46.009582 Y38.221993 I9.664493 J-3.087269",
	"G02 X50.960894 Y30.759827 I-76.101002 J-55.868432",
	"G02 X53.592587 Y23.727745 I-17.976898 J-10.736178",
	"G02 X53.489896 Y16.275560 I-19.258400 J-3.461418",
	"G02 X51.962836 Y10.074381 I-86.724114 J18.067481",
	"G02 X46.362715 Y7.309110 I-4.052851 J1.154468",
	"G03 X49.046344 Y15.257166 I-143.854139 J52.998856",
	"G03 X48.891712 Y23.862560 I-13.226904 J4.066410",
	"G03 X42.690462 Y33.338785 I-22.030114 J-7.649361",
	"G02 X38.085989 Y43.864643 I9.728856 J10.525858",
	"G02 X39.761929 Y49.342853 I9.791391 J0.000000",
	"G03 X42.569216 Y54.210550 I-32.988812 J22.268590",
	"G03 X43.651471 Y56.759027 I-24.478517 J11.899266",
	"G03 X43.258943 Y59.613414 I-2.889049 J1.056889",
	"G03 X41.911302 Y60.451474 I-1.691985 J-1.218228",
	"G03 X38.038328 Y60.740793 I-3.515557 J-20.993577",
	"G03 X34.084573 Y60.342555 I0.399567 J-23.792773",
	"G03 X32.683128 Y59.613414 I0.495783 J-2.664312",
	"G03 X31.581699 Y57.380533 I2.635335 J-2.688046",
	"G02 X30.958810 Y54.900277 I-10.193529 J1.241647",
	"G03 X28.864239 Y49.279191 I196.833608 J-76.546377",
	"G03 X29.234492 Y43.174916 I7.342824 J-2.617990",
	"G03 X32.701658 Y38.374631 I16.430701 J8.215342",
	"G02 X35.327081 Y32.829009 I-6.397108 J-6.422814",
	"G02 X33.982504 Y24.217931 I-17.407584 J-1.692406",
	"G03 X30.728899 Y16.275560 I220.112227 J-94.806931",
	"G03 X29.593479 Y11.718725 I17.319363 J-6.735314",
	"G02 X28.429810 Y7.309110 I-16.169756 J1.908745",
	"G02 X26.819910 Y13.461331 I3.176766 J4.118037",
	"G02 X29.579356 Y19.034470 I49.451373 J-21.015294",
	"G03 X31.476143 Y23.682662 I-16.800109 J9.566724",
	"G03 X31.878445 Y28.690646 I-13.791314 J3.628036",
	"G03 X29.407711 Y35.947795 I-16.647233 J-1.618475",
	"G02 X25.785857 Y42.485189 I59.284609 J37.116913",
	"G02 X25.298166 Y48.564950 I7.537507 J3.664066",
	"G02 X27.280264 Y54.210550 I63.321840 J-19.060743",
	"G02 X28.223884 Y56.487544 I114.635205 J-46.172478",
	"G03 X28.314855 Y59.038640 I-3.270698 J1.393802",
	"G03 X27.201409 Y60.068060 I-1.514691 J-0.521452",
	"G03 X24.543407 Y60.327524 I-2.154598 J-8.327853",
	"G03 X21.697763 Y59.796138 I0.673748 J-11.493123",
	"G03 X20.497948 Y58.923687 I0.725077 J-2.258374",
	"G03 X19.978570 Y56.270266 I2.627590 J-1.891863",
	"G02 X20.153085 Y53.520823 I-7.731488 J-1.870999",
	"G02 X18.769754 Y49.278339 I-10.917502 J1.213058",
	"G03 X16.934359 Y45.244097 I20.763519 J-11.881081",
	"G03 X17.602574 Y36.540091 I10.324812 J-3.585007",
	"G02 X20.612902 Y28.690646 I-30.710114 J-16.279551",
	"G02 X20.796591 Y20.503700 I-17.997354 J-4.499337",
	"G02 X18.198857 Y12.826920 I-31.557018 J6.400619",
	"G02 X16.516979 Y9.397092 I-499.644195 J242.882250",
	"G02 X13.945541 Y6.619380 I-5.982602 J2.959234",
	"G02 X14.625630 Y14.499670 I7.823892 J3.294270",
	"G03 X17.394176 Y22.483100 I-15.149721 J9.725481",
	"G03 X15.679057 Y30.221286 I-12.730018 J1.237639",
	"G02 X13.255814 Y37.657099 I15.562641 J9.184439",
	"G02 X14.289030 Y44.992268 I15.710470 J1.527410",
	"G03 X16.014722 Y52.141368 I-24.514161 J9.700202",
	"G02 X16.475255 Y55.616658 I50.097400 J-4.870568",
	"G03 X15.210041 Y58.693776 I-3.104861 J0.522046",
	"G03 X12.878783 Y59.451213 I-2.348419 J-3.261701",
	"G02 X10.611860 Y61.107821 I0.010219 J2.393330",
	"G02 X10.311631 Y64.179070 I6.866574 J2.221538",
	"G03 X10.496905 Y67.315365 I-26.452786 J3.136295",
	"G02 X11.197855 Y76.672221 I62.801983 J0.000000",
	"G02 X12.795995 Y85.937997 I218.777335 J-32.963511",
	"G02 X23.089857 Y106.836141 I43.552719 J-8.468583",
	"G02 X44.293533 Y117.665445 I24.346569 J-21.497403",
	"G02 X51.961750 Y117.370172 I2.750441 J-28.290347",
	"G02 X59.467530 Y115.826169 I-22.872496 J-130.204641",
	"G02 X70.112038 Y111.852166 I-10.433741 J-44.189989",
	"G02 X78.549978 Y103.870903 I-9.933955 J-18.953367",
	"G02 X84.834276 Y89.485804 I-53.412431 J-31.899075",
	"G02 X88.551021 Y74.212636 I-161.675525 J-47.432771",
	"G03 X89.931908 Y68.766586 I49.026371 J9.532913",
	"G02 X89.470659 Y63.177002 I-7.089446 J-2.228806",
	"G02 X85.810884 Y61.005154 I-3.539278 J1.794564",
	"G03 X82.343477 Y60.073230 I-0.188782 J-6.214151",
	"G03 X78.219235 Y53.677980 I4.685758 J-7.549274",
	"G03 X78.090161 Y45.933824 I33.879060 J-4.437825",
	"G03 X81.623177 Y36.146356 I20.972025 J2.038946",
	"G02 X84.987432 Y26.621465 I-16.484236 J-11.178927",
	"G02 X83.745331 Y19.842438 I-13.142636 J-1.095220",
	"G03 X80.964023 Y13.516650 I99.503352 J-47.523733",
	"G03 X79.627634 Y9.102311 I24.085353 J-9.701012",
	"G02 X76.710707 Y5.929650 I-4.114544 J0.855655"
};

/* 129 строк, траектория - "крокодил" */
char* GcodeBuffer4[243] =
{
	"0",
	"G00 X0.000000 Y0.000000",
	"G00 X18.906251 Y73.039063",
	"G01 X20.648438 Y67.816406",
	"G01 X24.783204 Y70.771484",
	"G01 X26.638673 Y65.824219",
	"G01 X30.158204 Y70.517578",
	"G01 X32.533204 Y63.990234",
	"G01 X36.042970 Y69.251953",
	"G01 X37.783204 Y64.027344",
	"G01 X41.398438 Y68.845703",
	"G01 X44.361329 Y62.919922",
	"G01 X47.910157 Y68.246094",
	"G01 X50.820313 Y63.009766",
	"G01 X54.886720 Y68.240234",
	"G01 X57.306642 Y62.794922",
	"G01 X60.333985 Y68.246094",
	"G01 X63.861329 Y62.955078",
	"G01 X67.046876 Y68.691406",
	"G01 X70.169923 Y62.447266",
	"G01 X75.460938 Y68.326172",
	"G01 X77.931642 Y63.384766",
	"G01 X80.345704 Y68.210938",
	"G01 X83.847657 Y62.955078",
	"G01 X86.773438 Y68.220703",
	"G01 X89.712892 Y63.517578",
	"G01 X92.626954 Y68.765625",
	"G01 X95.498048 Y63.597656",
	"G01 X99.617188 Y68.896484",
	"G01 X102.033201 Y64.501953",
	"G01 X104.675781 Y69.292969",
	"G01 X104.681781 Y69.292969",
	"G01 X107.033341 Y65.177734",
	"G01 X108.162251 Y65.177734",
	"G01 X111.355611 Y69.433594",
	"G01 X113.291161 Y64.501953",
	"G01 X114.291161 Y65.511719",
	"G01 X117.308731 Y69.533203",
	"G01 X120.396621 Y65.210938",
	"G01 X122.168111 Y69.939453",
	"G01 X125.658341 Y65.285156",
	"G01 X127.986471 Y70.525391",
	"G01 X131.513811 Y65.232422",
	"G01 X133.834121 Y70.453125",
	"G02 X134.462387 Y69.379390 I-32.725089 J-19.868843",
	"G02 X135.256001 Y67.951172 I-119.095884 J-67.112289",
	"G03 X136.405977 Y66.061404 I21.345238 J11.694386",
	"G03 X137.711081 Y65.015625 I2.324321 J1.563433",
	"G03 X139.089362 Y64.736994 I1.486717 J3.805990",
	"G03 X140.082171 Y64.921875 I0.064085 J2.413992",
	"G03 X140.944363 Y65.497346 I-1.035116 J2.484471",
	"G03 X141.586081 Y66.271484 I-3.684968 J3.707676",
	"G03 X142.663652 Y68.190142 I-10.843777 J7.352092",
	"G02 X143.535301 Y69.435547 I3.800342 J-1.732095",
	"G02 X144.691447 Y70.131850 I2.031842 J-2.065696",
	"G02 X145.226701 Y70.109375 I0.236745 J-0.746708",
	"G02 X145.742406 Y69.713356 I-0.474903 J-1.152221",
	"G02 X146.437641 Y68.445313 I-3.833650 J-2.926501",
	"G02 X146.886208 Y67.016375 I-15.010779 J-5.497003",
	"G03 X147.429831 Y65.474609 I9.689296 J2.549700",
	"G01 X147.562641 Y65.177734",
	"G01 X149.386861 Y65.177734",
	"G01 X149.519671 Y65.474609",
	"G03 X149.994948 Y66.798987 I-8.445426 J3.778261",
	"G02 X150.658341 Y68.593750 I10.787790 J-2.967476",
	"G02 X151.094706 Y69.366362 I5.397044 J-2.538671",
	"G02 X151.496231 Y69.818359 I1.831012 J-1.222212",
	"G02 X151.943974 Y70.063553 I0.811499 J-0.950456",
	"G02 X152.488421 Y70.087891 I0.319750 J-1.051001",
	"G02 X153.116346 Y69.796658 I-0.312799 J-1.496969",
	"G02 X153.506001 Y69.357422 I-0.994584 J-1.274770",
	"G02 X153.785573 Y68.737925 I-2.448186 J-1.477670",
	"G02 X154.031391 Y67.853516 I-12.993716 J-4.087921",
	"G03 X154.249312 Y66.970646 I96.224210 J23.282914",
	"G03 X154.564591 Y66.074219 I5.036765 J1.267806",
	"G03 X155.073622 Y65.302326 I2.754321 J1.262571",
	"G03 X155.947411 Y64.716797 I1.611633 J1.460305",
	"G03 X160.609386 Y64.065044 I3.880916 J10.760733",
	"G02 X164.886861 Y64.003906 I1.769603 J-25.856648",
	"G02 X170.589258 Y63.068722 I-4.262742 J-43.845699",
	"G03 X176.767721 Y62.832031 I3.704936 J15.953686",
	"G03 X178.335051 Y63.394384 I-0.655950 J4.293517",
	"G02 X179.509911 Y64.074219 I27.139763 J-45.546619",
	"G02 X180.627856 Y64.531881 I2.406757 J-4.284810",
	"G02 X181.838031 Y64.513672 I0.573473 J-2.110223",
	"G02 X182.413230 Y64.211940 I-0.506838 J-1.665319",
	"G02 X182.908341 Y63.751953 I-2.700405 J-3.403061",
	"G03 X183.405209 Y63.216437 I73.256264 J67.471133",
	"G03 X184.183731 Y62.599609 I2.442183 J2.282656",
	"G03 X185.065387 Y62.293333 I1.252149 J2.182360",
	"G03 X185.812641 Y62.222656 I1.033698 J6.943441",
	"G02 X186.564789 Y62.181977 I-1.162613 J-28.470127",
	"G02 X187.107561 Y62.070313 I-0.137681 J-2.044215",
	"G02 X188.125866 Y61.418025 I-0.876550 J-2.489402",
	"G02 X189.324361 Y59.707031 I-4.739649 J-4.595218",
	"G02 X189.830063 Y57.876978 I-4.703872 J-2.284727",
	"G02 X189.507951 Y56.652344 I-1.868890 J-0.163110",
	"G02 X188.912730 Y56.102602 I-1.506111 J1.033605",
	"G02 X187.834121 Y55.666016 I-2.117499 J3.680724",
	"G02 X186.618690 Y55.466629 I-1.783733 J7.069136",
	"G02 X185.078261 Y55.412109 I-1.408989 J18.020809",
	"G02 X181.808692 Y55.589240 I0.254276 J34.957821",
	"G03 X179.584121 Y55.593750 I-1.135004 J-11.202598",
	"G02 X170.568603 Y55.082660 I-10.847267 J111.572027",
	"G02 X161.408341 Y55.007813 I-9.160262 J560.508414",
	"G03 X155.444888 Y55.005037 I0.001695 J-6409.249269",
	"G03 X149.457171 Y53.792969 I0.014395 J-15.467058",
	"G01 X148.851701 Y53.539063",
	"G01 X149.257951 Y53.023438",
	"G03 X151.271006 Y51.426977 I4.350332 J3.418132",
	"G03 X153.845841 Y50.550781 I5.322164 J11.418625",
	"G03 X156.665276 Y50.113546 I4.717899 J21.113618",
	"G02 X159.007951 Y49.896484 I-22.806506 J-258.893311",
	"G03 X168.940923 Y49.118353 I25.726704 J264.618421",
	"G03 X179.091941 Y49.308594 I3.861281 J64.884641",
	"G03 X183.280593 Y49.920990 I-4.245845 J43.671556",
	"G02 X187.314591 Y50.482422 I7.102287 J-36.258061",
	"G02 X187.946531 Y50.518619 I1.013630 J-12.162005",
	"G02 X188.640761 Y50.476522 I0.118586 J-3.789802",
	"G02 X189.224726 Y50.290840 I-0.300070 J-1.954832",
	"G02 X189.486471 Y50.044881 I-0.279873 J-0.560087",
	"G02 X189.603468 Y49.455632 I-0.802866 J-0.465651",
	"G02 X189.214981 Y48.068318 I-5.135532 J0.690043",
	"G02 X188.483717 Y46.712977 I-8.587685 J3.758474",
	"G02 X187.966941 Y46.009725 I-6.451877 J4.199585",
	"G02 X182.901374 Y43.132092 I-6.312464 J5.214647",
	"G02 X176.617331 Y42.167928 I-757.618616 J4916.898359",
	"G02 X158.739937 Y39.819731 I-64.831054 J424.348062",
	"G02 X140.783341 Y37.958943 I-155.712190 J1415.050698",
	"G01 X130.203261 Y36.783162",
	"G02 X129.399990 Y36.780296 I-0.416940 J4.288499",
	"G03 X128.166161 Y36.861292 I-2.287880 J-25.413767",
	"G03 X127.003564 Y36.821906 I-0.319819 J-7.738112",
	"G03 X125.859521 Y36.406214 I0.279208 J-2.550547",
	"G03 X125.162983 Y35.606082 I1.117201 J-1.675800",
	"G03 X124.955221 Y34.820277 I1.924733 J-0.929256",
	"G03 X124.984825 Y33.980107 I4.099696 J-0.276152",
	"G02 X125.048921 Y33.318323 I-8.005099 J-1.109318",
	"G03 X125.321619 Y30.986345 I19.252832 J1.069460",
	"G02 X125.488371 Y28.359339 I-11.395038 J-2.042110",
	"G02 X125.307860 Y27.173363 I-5.968201 J0.301664",
	"G02 X124.923921 Y26.316370 I-2.694121 J0.692484",
	"G02 X124.306344 Y25.706190 I-1.809155 J1.213466",
	"G02 X123.099701 Y25.214808 I-1.866929 J2.857235",
	"G02 X122.095268 Y25.344425 I-0.308611 J1.565105",
	"G02 X121.212981 Y26.015589 I1.223187 J2.523448",
	"G02 X120.481468 Y27.109053 I3.755066 J3.303507",
	"G02 X120.048921 Y28.201136 I6.545173 J3.224085",
	"G02 X119.433544 Y31.016259 I16.959554 J5.182126",
	"G03 X118.584071 Y33.876917 I-9.591778 J-1.291827",
	"G03 X117.816322 Y35.007287 I-4.044112 J-1.920853",
	"G03 X116.634861 Y35.779261 I-2.153131 J-2.005175",
	"G03 X115.258655 Y35.958699 I-1.115512 J-3.188302",
	"G03 X113.033291 Y35.480433 I0.655316 J-8.465593",
	"G03 X112.251963 Y35.026985 I0.857307 J-2.377080",
	"G03 X111.761811 Y34.421839 I1.376776 J-1.616229",
	"G03 X111.498660 Y33.683424 I2.246701 J-1.216760",
	"G03 X111.418061 Y32.869105 I4.488062 J-0.855366",
	"G03 X111.580005 Y31.177057 I8.149367 J-0.073807",
	"G02 X111.941501 Y29.361292 I-268.817783 J-54.462119",
	"G02 X112.211222 Y27.510949 I-18.967566 J-3.709696",
	"G02 X112.113371 Y26.337855 I-3.280059 J-0.317030",
	"G02 X111.901436 Y25.846988 I-1.789556 J0.481467",
	"G02 X111.570401 Y25.478480 I-1.180718 J0.727711",
	"G02 X111.126431 Y25.233194 I-1.008705 J1.301330",
	"G02 X110.214931 Y25.025355 I-1.276702 J3.496446",
	"G02 X108.741621 Y25.223378 I-0.317343 J3.218742",
	"G02 X107.978611 Y25.759730 I0.681108 J1.779839",
	"G02 X107.431319 Y26.691218 I2.290399 J1.972239",
	"G02 X107.015721 Y28.187464 I9.054425 J3.320801",
	"G02 X106.778156 Y29.750851 I19.639608 J3.784086",
	"G03 X106.564541 Y31.371058 I-40.956899 J-4.575748",
	"G03 X106.241254 Y32.923499 I-14.418082 J-2.192601",
	"G03 X105.671971 Y34.126917 I-3.551270 J-0.943586",
	"G03 X105.088780 Y34.646561 I-1.459366 J-1.050753",
	"G03 X104.349701 Y34.953089 I-1.687573 J-3.024692",
	"G03 X103.546237 Y35.113565 I-1.399403 J-4.914865",
	"G03 X102.662201 Y35.179652 I-1.223357 J-10.418765",
	"G03 X100.722184 Y35.122362 I-0.507650 J-15.685470",
	"G03 X99.632903 Y35.019495 I18.098626 J-197.469440",
	"G02 X90.848237 Y34.219096 I-70.484566 J724.986070",
	"G02 X82.046966 Y33.845667 I-8.801271 J103.530858",
	"G02 X80.829526 Y33.966120 I-0.000000 J6.212646",
	"G03 X78.523528 Y34.367152 I-9.155330 J-45.814213",
	"G03 X76.422477 Y34.547570 I-2.516121 J-16.977369",
	"G03 X74.796966 Y34.044886 I-0.064606 J-2.670609",
	"G03 X73.927621 Y32.882089 I1.413436 J-1.963105",
	"G03 X73.666107 Y31.480433 I4.421833 J-1.550227",
	"G03 X73.734008 Y29.975381 I9.813102 J-0.311334",
	"G02 X73.896575 Y28.488245 I-57.100651 J-6.994427",
	"G02 X73.949206 Y26.995361 I-12.266736 J-1.179831",
	"G02 X73.752044 Y26.074183 I-2.553734 J0.064894",
	"G02 X73.277504 Y25.490411 I-1.228925 J0.514217",
	"G02 X72.003997 Y25.025355 I-1.540402 J2.242015",
	"G02 X70.371883 Y25.278821 I-0.324536 J3.291723",
	"G02 X69.734466 Y25.831995 I0.549680 J1.277224",
	"G02 X69.371881 Y26.834349 I2.283472 J1.392764",
	"G02 X69.234466 Y28.529261 I12.833434 J1.893498",
	"G02 X69.237654 Y30.236614 I49.687406 J0.760904",
	"G03 X69.138766 Y31.871058 I-10.310432 J0.196406",
	"G03 X68.974660 Y32.642450 I-5.606711 J-0.789617",
	"G03 X68.683688 Y33.324183 I-2.878300 J-0.825534",
	"G03 X68.215197 Y33.893595 I-1.987630 J-1.157913",
	"G03 X67.519625 Y34.304652 I-1.430405 J-1.626430",
	"G03 X66.376570 Y34.466753 I-0.960825 J-2.664080",
	"G02 X65.576266 Y34.433558 I-1.123670 J17.426815",
	"G03 X63.478506 Y33.750664 I0.069971 J-3.778410",
	"G03 X62.502047 Y32.523402 I1.584682 J-2.262923",
	"G03 X62.128405 Y30.817233 I4.822526 J-1.950106",
	"G03 X62.086031 Y28.970667 I38.493358 J-1.807088",
	"G02 X62.037922 Y27.066951 I-36.262735 J-0.036067",
	"G02 X61.777438 Y25.931605 I-3.359697 J0.173265",
	"G02 X61.506011 Y25.490278 I-1.577588 J0.666127",
	"G02 X61.148531 Y25.203089 I-0.922389 J0.782066",
	"G02 X60.700330 Y25.053329 I-0.677779 J1.282887",
	"G02 X59.755953 Y25.025355 I-0.579775 J3.617996",
	"G02 X58.402159 Y25.523768 I0.286636 J2.866365",
	"G02 X57.752047 Y26.259730 I1.169551 J1.688242",
	"G02 X57.379347 Y27.368665 I3.295765 J1.724766",
	"G02 X57.195406 Y28.958948 I15.434576 J2.591027",
	"G02 X57.106640 Y30.556700 I94.102256 J6.029338",
	"G03 X56.902438 Y32.062464 I-8.657251 J-0.407314",
	"G03 X56.343239 Y33.380897 I-3.931948 J-0.889888",
	"G03 X55.173922 Y34.304652 I-1.966949 J-1.287868",
	"G03 X53.905284 Y34.543820 I-1.376272 J-3.816025",
	"G03 X52.642672 Y34.517542 I-0.354004 J-13.337294",
	"G03 X51.349537 Y34.422464 I8.420977 J-123.372841",
	"G02 X50.349703 Y34.431602 I-0.447996 J5.685336",
	"G02 X45.090204 Y35.204090 I5.261765 J54.115754",
	"G02 X39.841797 Y36.376953 I20.715591 J105.028948",
	"G02 X23.297288 Y43.408047 I13.953428 J55.813672",
	"G02 X11.261719 Y56.500000 I17.756125 J28.401578",
	"G02 X10.119812 Y58.798534 I83.837665 J43.083283",
	"G02 X8.949219 Y61.888672 I17.472202 J8.385537",
	"G02 X8.540524 Y64.891607 I10.336672 J2.936084",
	"G02 X9.265625 Y67.154297 I3.970003 J-0.024699",
	"G02 X10.099075 Y67.816453 I1.545044 J-1.089129",
	"G02 X10.955078 Y68.017578 I1.070850 J-2.635441",
	"G02 X12.016112 Y68.081637 I2.624464 J-34.650743",
	"G03 X13.490234 Y68.464844 I-0.164889 J3.661228",
	"G03 X16.474057 Y70.794580 I-4.276212 J8.552425",
	"G02 X18.906250 Y73.039063 I10.772036 J-9.232879",
	"G01 X18.906251 Y73.039063"
};

/* Экземпляр структуры интерполятора */
INTERPOLATOR_StructDef interpolator;

/* Fifo буфер g - команд */
FIFO_CHAR_StructDef fifoGcodeBuf;

/* Импортированный FIFO буфер шагов интерполятора */
extern FIFO_StructDef fifoBufSteps;

/** Инициализация структуры обработчика g - команд
 */
void handlerGcodeInit(HANDLER_GCODE_StructDef* ghandler)
{
	ghandler->interpolator = &interpolator;

	ghandler->_workState = HANDLER_GCODE_READY;
	ghandler->_command = NONE;

	/* Инициализация структуры интерполятора */
	interpolatorInit(ghandler->interpolator);

	/* Инициализация FIFO буфера G - команд */
	fifoInitChar(&fifoGcodeBuf, GcodeBuffer, FIFO_GCODE_BUF_SIZE);
}

/** Тикер обработчика g - кода
 * 	В теле тикера происходит анализ g - кода и расчет шагов интерполятором
 * 	В результате работы обработчика заполняется буфер шагов интерполятора, который
 * 	в дальнейшем библиотека planner.h использует для планирования скорости движения
 */
void tickGcodeHandler(HANDLER_GCODE_StructDef* ghandler)
{
	if(availableForReadChar(&fifoGcodeBuf) == FIFO_OK)
	{
		handlerGcode(ghandler);
	}

	handlerGcommand(ghandler);
}

/** Обработчик g - команд, на вход поступает строка (в будущем будет бинарное представление команды)
 * 	На выходе передается статус, что G команда обработана, и выставлен статус обработчика - номер g - команды,
 * 	по которой необходимо считать шаги
 */
void handlerGcode(HANDLER_GCODE_StructDef* ghandler)
{
	if(ghandler->_workState == HANDLER_GCODE_READY)
	{
		char str[128] = {0};

		fifoReadChar(&fifoGcodeBuf, str);

		if (str[0] == 'G')
		{
			/* Конечные координаты участка траектории в соответствии с g - командой (мм) */
			Xk = atof(strchr(str, 'X') + 1);
			Yk = atof(strchr(str, 'Y') + 1);

			if (str[2] == '0')
			{
				x = round(Xk / MM_PER_STEP); y = round(Yk / MM_PER_STEP);
				X = Xk; Y = Yk;

				ghandler->_command = G00;

				ghandler->_workState = HANDLER_GCODE_DONE;
				return ;
			}

			if (str[2] == '1')
			{
				/* Инициализация и расчет параметров отрезка */
				if (setLine(&line, Xk, Yk) == INTERPOLATOR_DONE)
				{
					ghandler->_command = G01;

					ghandler->_workState = HANDLER_GCODE_DONE;
					return ;
				}
			}

			if (str[2] == '2')
			{
				/* Относительные координаты центра дуги (мм) */
				I = atof(strchr(str, 'I') + 1);
				J = atof(strchr(str, 'J') + 1);

				/* Инициализация и расчет параметров дуги G02 */
				if (setArc(&arc, Xk, Yk, I, J, 1) == INTERPOLATOR_DONE)
				{
					ghandler->_command = G02;

					ghandler->_workState = HANDLER_GCODE_DONE;
					return ;
				}
			}

			if (str[2] == '3')
			{
				/* Относительные координаты центра дуги (мм) */
				I = atof(strchr(str, 'I') + 1);
				J = atof(strchr(str, 'J') + 1);

				/* Инициализация и расчет параметров дуги G03 */
				if (setArc(&arc, Xk, Yk, I, J, -1) == INTERPOLATOR_DONE)
				{
					ghandler->_command = G03;

					ghandler->_workState = HANDLER_GCODE_DONE;
					return ;
				}
			}
		}
		else
		{
			ghandler->_workState = HANDLER_GCODE_READY;
			return ;
		}
	}

	return ;
}

/** Расчетный обработчик конкретной g - команды
 */
void handlerGcommand(HANDLER_GCODE_StructDef* ghandler)
{
	if(ghandler->_workState == HANDLER_GCODE_DONE)
	{

		switch(ghandler->_command)
		{
			case NONE:
			{
				ghandler->_workState = HANDLER_GCODE_READY;
				return ;
			}

			/* Расчет команды G00 */
			case G00:
			{
				ghandler->_workState = HANDLER_GCODE_READY;
				return;
			}

			/* Расчет команды G01 */
			case G01:
			{
				if(handlerLine(&interpolator, &fifoBufSteps, &line, 0, 1) == INTERPOLATOR_DONE)
				{
					ghandler->_workState = HANDLER_GCODE_READY;
				}
				break;
			}

			/* Расчет команды G02 */
			case G02:
			{
				if(handlerArc(&interpolator, &fifoBufSteps, &arc, 0, 1) == INTERPOLATOR_DONE)
				{
					ghandler->_workState = HANDLER_GCODE_READY;
				}
				break;
			}

			/* Расчет команды G03 */
			case G03:
			{
				if(handlerArc(&interpolator, &fifoBufSteps, &arc, 0, 1) == INTERPOLATOR_DONE)
				{
					ghandler->_workState = HANDLER_GCODE_READY;
				}
				break;
			}
		}
	}

	return;
}

/**	Обработчик статуса завершения исполнения программы движения
 * 	отслеживает статуc структуры ghandler
 */
void handlerEndState(HANDLER_GCODE_StructDef* ghandler)
{
	if (ghandler->_workState == HANDLER_GCODE_READY)
	{
		if (ghandler->interpolator->_workState == INTERPOLATOR_READY) ghandler->_workState = HANDLER_GCODE_END;
	}

	return;
}
